---
author: "Hector Roux de BÃ©zieux"
date: '`r format(Sys.time(), "%d %B , %Y")`'
title: 'Impact of all the methods on ARI merging'
output:
  html_document:
    toc: true
    toc_float: TRUE
    toc_depth: 2
    number_sections: true
    code_download: TRUE
---

```{r load packages, include=F}
library(knitr)
opts_chunk$set(
  fig.pos = "!h", out.extra = "", warning = F, message = F,
  fig.align = "center", echo = F
)
libs <- c("here", "dplyr", "ggplot2", "tidyr", "stringr", "readr", "cowplot",
          "mclust", "RColorBrewer", "purrr", "Dune", "pracma")
suppressMessages(
  suppressWarnings(sapply(libs, require, character.only = TRUE))
)
rm(libs)
```


```{r}
comp_merger_with_ref <- function(clusMat, clus, ref) {
  return(adjustedRandIndex(as.matrix(clusMat)[,clus], ref))
}
n_clus  <- function(clusMat, clus) {
  return(n_distinct(as.matrix(clusMat)[,clus]))
}
comp_tree_with_ref <- function(x, ref) {
  return(adjustedRandIndex(x, ref))
}

```

```{r}
comp_dune_ref <- function(dataset, comp = "", ref) {
  if (comp == "") {
    df <- readRDS(here("data", "Dune",
                        paste0(dataset, "_mergers.rds")))
  } else {
    df <- readRDS(here("data", "singleTree",
                        paste0(dataset, comp, "_mergers.rds")))
  }
  
  ARI_ref_sc3 <- data.frame(
    "n_clus" = functionTracking(df, n_clus, clus = "sc3"),
    "ARI" = functionTracking(df, comp_merger_with_ref, clus = "sc3",
                             ref = allen_clusters))[-1, ] %>%
    arrange(desc(n_clus)) %>%
    distinct()
  ARI_ref_sc3 <- trapz(x = ARI_ref_sc3$n_clus, y = ARI_ref_sc3$ARI)
  
  ARI_ref_seurat <- data.frame(
    "n_clus" = functionTracking(df, n_clus, clus = "Seurat"),
    "ARI" = functionTracking(df, comp_merger_with_ref, clus = "Seurat",
                             ref = allen_clusters))[-1, ] %>%
    arrange(n_clus) %>%
    distinct()
  
  ARI_ref_monocle <- data.frame(
    "n_clus" = functionTracking(df, n_clus, clus = "Monocle"),
    "ARI" = functionTracking(df, comp_merger_with_ref, clus = "Monocle",
                             ref = allen_clusters))[-1, ] %>%
    arrange(n_clus) %>%
    distinct()
  
  
}

load_DE_tree <- function(dataset, comp, ref) {
  df <- read.csv(here("Data", "singleTree",
                        paste0(dataset, comp, "_hierarchical_DE.csv"))) %>%
    arrange(cells) %>%
    select(-cells) %>%
    map_df(., comp_with_ref, y = ref) %>%
    t() %>%
    as.data.frame() %>%
    dplyr::rename("n_clus" = V1, "ari" = V2) %>%
    mutate(clustering_method = rownames(.),
           level = word(clustering_method, 2, sep = "\\_"),
           level = as.numeric(level),
           clustering_method = word(clustering_method, 1, sep = "\\."))
  return(df)
}

load_Dist_tree <- function(dataset, comp, ref) {
  df <- read.csv(here("Data", "singleTree",
                      paste0(dataset, comp, "_hierarchical_Dist.csv"))) %>%
    arrange(cells) %>%
    select(-cells) %>%
    map_df(., comp_with_ref, y = ref) %>%
    t() %>%
    as.data.frame() %>%
    dplyr::rename("n_clus" = V1, "ari" = V2) %>%
    mutate(clustering_method = rownames(.),
           level = word(clustering_method, 2, sep = "\\_"),
           level = as.numeric(level),
           clustering_method = word(clustering_method, 1, sep = "\\."))
  return(df)
}
```


```{r}
load_sc3 <- function(dataset, dune) {
  sc3_init <- dune[, "sc3.Initial"]
  SC3 <- read.csv(here("Data", "singleMethod",
                       paste0(dataset, "_SC3.csv"))) %>%
    select(-X) %>%
    arrange(cells) %>%
    select(-cells)
  colnames(SC3) <- str_remove(colnames(SC3), "X") %>%
    str_replace("\\.", "-") %>% unlist
  sc3_param <- colnames(SC3)[which.max(colSums(SC3 == sc3_init))] %>%
    as.numeric()
  keep <- as.numeric(colnames(SC3)) <= sc3_param
  SC3 <- SC3[, keep]
  colnames(SC3) <- paste("sc3", colnames(SC3), sep = "_")
  return(SC3)
}

load_monocle <- function(dataset, dune) {
  Monocle_init <- dune[, "Monocle.Initial"]
  Monocle <- read.csv(here("Data", "singleMethod",
                       paste0(dataset, "_Monocle.csv"))) %>%
    select(-X) %>%
    arrange(cells) %>%
    select(-cells)
  colnames(Monocle) <- str_remove(colnames(Monocle), "k_") %>% unlist()
  Monocle_param <- colnames(Monocle)[which.max(colSums(Monocle == Monocle_init))] %>%
    as.numeric()
  keep <- as.numeric(colnames(Monocle)) >= Monocle_param
  Monocle <- Monocle[, keep]
  colnames(Monocle) <- paste("Monocle", colnames(Monocle), sep = "_")
  return(Monocle)
}

load_seurat <- function(dataset, dune) {
  Seurat_init <- dune[, "Seurat.Initial"]
  Seurat <- read.csv(here("Data", "singleMethod",
                           paste0(dataset, "_Seurat.csv"))) %>%
    select(-X) %>%
    arrange(cells) %>%
    select(-cells)
  colnames(Seurat) <- str_remove(colnames(Seurat), "X") %>% unlist()
  Seurat_param <- colnames(Seurat)[which.max(colSums(Seurat == Seurat_init))]
  k_seurat <- word(Seurat_param, 3, sep = "\\.")
  keep <- str_detect(colnames(Seurat), k_seurat) %>% unlist()
  Seurat <- Seurat[, keep]
  colnames(Seurat) <- str_remove(colnames(Seurat), paste0(".", k_seurat))
  Seurat_param <- colnames(Seurat)[which.max(colSums(Seurat == Seurat_init))] %>%
    as.numeric()
  keep <- as.numeric(colnames(Seurat)) <= Seurat_param
  Seurat <- Seurat[, keep]
  colnames(Seurat) <- paste("Seurat", colnames(Seurat), sep = "_")
  return(Seurat)
}

load_singles <- function(dataset, comp, ref) {
  if (comp == "") {
    dune <- read.csv(here("data", "Dune",
                        paste0(dataset, ".csv")))
  } else {
    dune <- read.csv(here("data", "singleTree",
                        paste0(dataset, comp, "_Dune.csv")))
  }
  dune <- dune %>% arrange(cells)
  Seurat <- load_seurat(dataset, dune)
  SC3 <- load_sc3(dataset, dune)
  Monocle <- load_monocle(dataset, dune)
  df <- cbind(Seurat, SC3, Monocle) %>%
    as.data.frame() %>%
    map_df(., comp_with_ref, y = ref) %>%
    t() %>%
    as.data.frame() %>%
    dplyr::rename("n_clus" = V1, "ari" = V2) %>%
    mutate(clustering_method = rownames(.),
           level = word(clustering_method, 2, sep = "_"),
           level = as.numeric(level),
           clustering_method = word(clustering_method, 1, sep = "_"))
}
```

```{r}
all_comp <- function(dataset, comp, ref) {
  df1 <- bind_rows("Dune" = load_dune(dataset, comp, ref),
                   "DE" = load_DE_tree(dataset, comp, ref),
                   .id = "Method") %>%
    mutate(comp = "Dune versus Hierarchical DE")
  df2 <- bind_rows("Dune" = load_dune(dataset, comp, ref),
                   "Dist" = load_Dist_tree(dataset, comp, ref),
                   .id = "Method") %>%
    mutate(comp = "Dune versus Hierarchical Dist")
  df3 <- bind_rows("Dune" = load_dune(dataset, comp, ref),
                   "Param" = load_singles(dataset, comp, ref),
                   .id = "Method") %>%
    mutate(comp = "Dune versus new parameters")
  df <- bind_rows(df1, df2, df3) %>%
    arrange(level)
  
  p <- ggplot(df %>% filter(n_clus > 10),
              aes(x = n_clus,
                  y = ari,
                  linetype = clustering_method,
                  col = Method,
                  group = interaction(clustering_method, Method))) +
    geom_path(size = 1.8) +
    theme_classic() +
    scale_linetype_manual(values = linetypes) +
    scale_color_brewer(type = "qual", palette = "Dark2") +
    labs(x = "Resolution",
         y = "ARI with glod standard",
         linetype = "Clustering\nmethod",
         col = "Method of\nmerging") +
    facet_wrap(~comp) +
  NULL
  return(p)
}
```