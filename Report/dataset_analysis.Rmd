---
author: "Hector Roux de BÃ©zieux"
date: '`r format(Sys.time(), "%d %B , %Y")`'
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    
params:
  dataset: SMARTer_cells_MOp 
  title: "Analysis of the SMARTer_cells_MOp dataset"
---
---
title: `r params$title`
---

```{r packages, include=F}
library(knitr)
opts_chunk$set(
  fig.pos = "!h", out.extra = "", warning = F, message = F,
  fig.width = 5, fig.align = "center", echo = F
)
libs <- c("here", "tidyverse", "cowplot", "clusterExperiment", "mclust")
suppressMessages(
  suppressWarnings(sapply(libs, require, character.only = TRUE))
)
rm(libs)
suppressMessages(suppressWarnings(source(here("Report", "helper.R"))))
type <- type(params$dataset)
mergers <- readRDS(here("data", type, paste0(params$dataset, "_mergers.rds")))

mergers_no_allen <- readRDS(here("data", type,
                                 paste0(params$dataset, "_no_allen_mergers.rds")))
```

# General comments

We have the following workflow

```{r workflow}
ggdraw() + draw_image(here("Figures", "SMART-Seq_workflow.png"))
```

In the Seurat clustering, there are two parameters to choose from: the resolution and the k.param (use in a knn step). From the seurat help file, for the resolution parameter: use a value above (below) 1.0 if you want to obtain a larger (smaller) number of communities.

We picked a value of 1.6 as we want many clusters to start with. We also pick k = 50. Those values seem intermediate in term of ARI with other pairs of paramters (see section Seurat ARI param)

We also consider two ways of computing the ARI between RSEC and other methods. Either, we force RSEC to assign all cells to a given cluster, or we only compute the ARI between RSEC and the other methods on those cells that RSEC do cluster. Note that in the second case, other pairs of methods are compared using all cells. We denote as RsecT the cluster assignement where all cells are assigned (i.e Rsec Total). 

# ARI clustering with the Allen dataset
## Reduction in the number of clusters
```{r allen}
plotPrePost(mergers)
```

## Improvement in ARI

```{r ARI_imp_allen}
plotARIReduce(mergers)
```

# ARI clustering without the Allen dataset
## Reduction in the number of clusters

```{r Imp no allen}
plotPrePost(mergers_no_allen)
```

## Improvement in ARI

```{r ARI imp no allen cell}
plotARIReduce(mergers_no_allen)
```

## Comparison with Allen subclass

```{r comp cell}
allen_clusters <- read.csv(here("data", type,
                                paste0(params$dataset, "_cluster.membership.csv")),
                           col.names = c("cells", "cluster_id"))
clusters <- read.csv(here("data", type,
                          paste0(params$dataset, "_cluster.annotation.csv")),
                     header = T)
allen_clusters <- full_join(allen_clusters, clusters)
rm(clusters)

apply(mergers_no_allen$currentMat, 2, function(x) {
    inds <- x != -1
    xa <- x[inds]
    y <- allen_clusters$subclass_label[inds]
    mclust::adjustedRandIndex(xa, y)
}) %>% data.frame(method = names(.), ARI = round(., 2)) %>%
  kable(row.names = F)
```

## Last consensus step

```{r}
props <- c(1/3, 2/3, 1)
names(props) <- round(props, 2)
clusters <- mergers_no_allen$currentMat
clusters[, "Rsec"] <- assignRsec(mergers_no_allen)

lapply(props, function(p){
  cellsConsensus <- suppressWarnings(
    makeConsensus(x = clusters, clusterLabel = "makeConsensus",
                  proportion = p, minSize = 20)
                  )
  consensus <- cbind(cellsConsensus$clustering,
                     allen_clusters$subclass_label,
                     clusters)

  colnames(consensus)[c(1, 2)] <- c("Consensus", "Allen")
  plotClusters(object = consensus)
  title(paste("Consensus Merging with proportion ", round(p, 2)))

  consensus <- cellsConsensus$clustering
  inds <- consensus != -1
  ARI <- adjustedRandIndex(consensus[inds],
                           allen_clusters$subclass_label[inds])
  return(ARI)
}) %>% unlist() %>%
  data.frame(prop = names(.), ARI = round(., 2)) %>%
  select(prop, ARI) %>%
  kable(row.names = F)

rm(props, clusters)
```

# Seurat ARI Param

```{r}
ggdraw() + draw_image(here("Figures", type,
                           paste0(params$dataset, "_seurat_ARI.pdf"))
                      )
```